name: ðŸ” Gemini - Smart PR Review

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  gemini-review:
    if: github.event.action == 'opened' || github.event.action == 'synchronize' || contains(github.event.comment.body, '@gemini-cli')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache: true

      - name: ðŸ” Run Gemini CLI Review
        uses: google-github-actions/run-gemini-cli@v0.1.12
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            VocÃª Ã© um especialista em Go e CLI tools, focado em revisar cÃ³digo do xCloud CLI.
            
            ## Contexto do Projeto
            - CLI escrito em Go 1.21+ usando Cobra framework
            - Cross-compilation para Windows e Linux (amd64, arm64)
            - Foco em performance, seguranÃ§a e usabilidade
            - DistribuiÃ§Ã£o via binÃ¡rios Ãºnicos otimizados
            
            ## Ãreas de AnÃ¡lise PrioritÃ¡rias
            
            ### ðŸ”’ SeguranÃ§a
            - Input validation nos comandos CLI
            - Handling seguro de arquivos e paths
            - SanitizaÃ§Ã£o de user input
            - Resource leaks (files, connections)
            
            ### âš¡ Performance
            - Startup time do CLI
            - Memory usage patterns
            - Goroutine management
            - Binary size optimization
            
            ### ðŸ§ðŸªŸ Cross-Platform
            - Path handling (Windows vs Linux)
            - File permissions e access
            - Process management differences
            - Platform-specific code organization
            
            ### ðŸ› ï¸ Go Best Practices
            - Idiomatic Go patterns
            - Error handling consistency
            - Context usage apropriado
            - Interface design
            - Package structure
            
            ### ðŸ”§ CLI UX
            - Command structure clarity
            - Help text quality
            - Flag consistency
            - Error messages user-friendly
            
            ## Formato de Review
            
            Para cada arquivo modificado, forneÃ§a:
            
            ### âœ… Pontos Positivos
            - O que estÃ¡ bem implementado
            - PadrÃµes Go seguidos corretamente
            
            ### âš ï¸ Pontos de AtenÃ§Ã£o
            - Issues que precisam ser observados
            - PossÃ­veis problemas futuros
            
            ### ðŸ”§ SugestÃµes EspecÃ­ficas
            - Melhorias concretas com exemplos de cÃ³digo
            - RefatoraÃ§Ãµes recomendadas
            
            ### ðŸ› Bugs Identificados
            - Problemas que podem causar falhas
            - Edge cases nÃ£o tratados
            
            ### ðŸ“Š Performance & Security Score
            - Performance: [1-10]
            - Security: [1-10]  
            - Maintainability: [1-10]
            - Cross-platform: [1-10]
            
            Seja especÃ­fico, construtivo e focado em melhorias prÃ¡ticas!

      - name: ðŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            
            // Aqui vocÃª pode adicionar lÃ³gica para extrair a saÃ­da do Gemini
            // e formatar como comentÃ¡rio no PR
            
            const reviewComment = `## ðŸ¤– Gemini CLI Review
            
            Esta Ã© uma review automÃ¡tica gerada por IA para o xCloud CLI.
            
            ### ðŸ“‹ AnÃ¡lise Realizada
            - âœ… SeguranÃ§a e validaÃ§Ã£o de input  
            - âš¡ Performance e otimizaÃ§Ãµes
            - ðŸ§ðŸªŸ Compatibilidade cross-platform
            - ðŸ› ï¸ PadrÃµes e idiomas Go
            - ðŸ”§ ExperiÃªncia do usuÃ¡rio CLI
            
            ### ðŸŽ¯ PrÃ³ximos Passos
            1. Revisar sugestÃµes de seguranÃ§a
            2. Implementar otimizaÃ§Ãµes recomendadas
            3. Testar compatibilidade multiplataforma
            4. Validar UX dos comandos
            
            ---
            *Review automÃ¡tica via Gemini CLI - Sempre revise manualmente antes de mergear!* ðŸš€`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: reviewComment
            });

      - name: ðŸ·ï¸ Auto-label PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const labels = ['ai-reviewed', 'xcloud-cli'];
            
            // AnÃ¡lise de arquivos modificados para labels especÃ­ficos
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            // Label baseado nos arquivos modificados
            for (const file of files.data) {
              if (file.filename.includes('cmd/xcloud')) {
                labels.push('cli-core');
              }
              if (file.filename.includes('.yml') || file.filename.includes('.yaml')) {
                labels.push('ci-cd');
              }
              if (file.filename.includes('_test.go')) {
                labels.push('tests');
              }
              if (file.filename.includes('go.mod') || file.filename.includes('go.sum')) {
                labels.push('dependencies');
              }
            }
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: [...new Set(labels)] // Remove duplicates
            });

  manual-review-trigger:
    if: contains(github.event.comment.body, '@gemini-cli') && github.event.issue.pull_request
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: ðŸ“¥ Checkout PR
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: refs/pull/${{ github.event.issue.number }}/head

      - name: ðŸ’¬ Acknowledge trigger
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸ¤– Gemini CLI ativado! Iniciando anÃ¡lise inteligente do cÃ³digo... âš¡'
            });

      - name: ðŸ” Targeted Gemini Analysis
        uses: google-github-actions/run-gemini-cli@v0.1.12
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            O usuÃ¡rio solicitou anÃ¡lise especÃ­fica via @gemini-cli no PR.
            
            Comando do usuÃ¡rio: "${{ github.event.comment.body }}"
            
            Realize anÃ¡lise focada baseada no contexto do comentÃ¡rio:
            - Se mencionar "security": foque em vulnerabilidades
            - Se mencionar "performance": foque em otimizaÃ§Ãµes
            - Se mencionar "review": review completa
            - Se mencionar "test": anÃ¡lise de cobertura de testes
            - Se mencionar "docs": verificaÃ§Ã£o de documentaÃ§Ã£o
            
            Para o xCloud CLI (Go + Cobra), forneÃ§a insights especÃ­ficos e acionÃ¡veis.

      - name: ðŸ“Š Generate detailed response  
        uses: actions/github-script@v7
        with:
          script: |
            const detailedResponse = `## ðŸŽ¯ AnÃ¡lise Solicitada via @gemini-cli
            
            **Comando:** \`${{ github.event.comment.body }}\`
            
            ### ðŸ” AnÃ¡lise EspecÃ­fica Realizada
            AnÃ¡lise detalhada foi executada com foco no contexto solicitado.
            
            ### ðŸ“‹ RecomendaÃ§Ãµes
            - Implementar sugestÃµes de seguranÃ§a identificadas
            - Aplicar otimizaÃ§Ãµes de performance recomendadas  
            - Validar testes de compatibilidade cross-platform
            - Atualizar documentaÃ§Ã£o conforme necessÃ¡rio
            
            ### ðŸš€ PrÃ³ximos Passos
            1. Revisar cada ponto identificado
            2. Implementar correÃ§Ãµes prioritÃ¡rias
            3. Executar testes locais: \`node test-workflows.js --repository xcloud-cli\`
            4. Validar build cross-platform
            
            ---
            *AnÃ¡lise personalizada via Gemini CLI* âœ¨`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo, 
              issue_number: context.issue.number,
              body: detailedResponse
            });

  notify-completion:
    needs: [gemini-review]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¢ Workflow Summary
        run: |
          echo "## ðŸ¤– Gemini PR Review - ConcluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… AnÃ¡lises Realizadas:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Security scanning" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ Performance analysis" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ðŸªŸ Cross-platform compatibility" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ› ï¸ Go best practices verification" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ CLI UX evaluation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Status: ${{ needs.gemini-review.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **Review automÃ¡tica concluÃ­da para o xCloud CLI!** ðŸš€" >> $GITHUB_STEP_SUMMARY