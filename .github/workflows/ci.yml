name: 'ğŸ”„ CI - Tests & Quality Checks'

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

concurrency:
  group: '${{ github.workflow }}-${{ github.ref }}'
  cancel-in-progress: true

jobs:
  lint:
    name: 'ğŸ” Lint & Format Check'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: 'ğŸ“¥ Checkout code'
        uses: actions/checkout@v4

      - name: 'ğŸ”§ Setup Go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: 'ğŸ“¦ Install dependencies'
        run: go mod download

      - name: 'ğŸ” Run go fmt'
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -l .
            exit 1
          fi

      - name: 'ğŸ” Run go vet'
        run: go vet ./...

      - name: 'ğŸ” Run golangci-lint'
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

  test:
    name: 'ğŸ§ª Tests (Go ${{ matrix.go-version }})'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        go-version: ['1.20', '1.21']

    steps:
      - name: 'ğŸ“¥ Checkout code'
        uses: actions/checkout@v4

      - name: 'ğŸ”§ Setup Go ${{ matrix.go-version }}'
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: 'ğŸ“¦ Install dependencies'
        run: go mod download

      - name: 'ğŸ§ª Run tests'
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: 'ğŸ“Š Upload coverage to Codecov'
        if: matrix.go-version == '1.21'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  build:
    name: 'ğŸ—ï¸ Build'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lint, test]

    steps:
      - name: 'ğŸ“¥ Checkout code'
        uses: actions/checkout@v4

      - name: 'ğŸ”§ Setup Go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: 'ğŸ“¦ Install dependencies'
        run: go mod download

      - name: 'ğŸ—ï¸ Build binary'
        run: go build -v -o xcloud ./cmd/xcloud/main.go

      - name: 'âœ… Verify binary'
        run: ./xcloud --version || echo "Binary created successfully"

      - name: 'ğŸ“¦ Upload artifact'
        uses: actions/upload-artifact@v4
        with:
          name: xcloud-cli-${{ github.sha }}
          path: xcloud
          retention-days: 7

  quality-gate:
    name: 'âœ… Quality Gate'
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    if: always()

    steps:
      - name: 'ğŸ“Š Check results'
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "âŒ Quality gate failed!"
            exit 1
          fi
          echo "âœ… All checks passed!"
