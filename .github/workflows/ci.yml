name: CI/CD Pipeline - Go CLI

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  release:
    types: [published]

env:
  GO_VERSION: '1.21'
  APP_NAME: 'xcloud-cli'

jobs:
  lint-and-format:
    name: ðŸ” Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ðŸ“¦ Download dependencies
        run: go mod download

      - name: ðŸ” Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m

      - name: ðŸ§¹ Check formatting
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "âŒ Code is not formatted. Please run 'gofmt -s -w .'"
            gofmt -s -l .
            exit 1
          fi
          echo "âœ… Code is properly formatted"

      - name: ðŸ”§ Check modules
        run: |
          go mod tidy
          if ! git diff --quiet go.mod go.sum; then
            echo "âŒ go.mod or go.sum is not tidy"
            git diff go.mod go.sum
            exit 1
          fi

  test:
    name: ðŸ§ª Test Go ${{ matrix.go-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        go-version: ['1.20', '1.21', '1.22']

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go ${{ matrix.go-version }}
        uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: ðŸ“¦ Download dependencies
        run: go mod download

      - name: ðŸ§ª Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: ðŸ“Š Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' && matrix.go-version == '1.21'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella

  build:
    name: ðŸ”¨ Build Binaries
    runs-on: ubuntu-latest
    needs: [lint-and-format, test]
    strategy:
      matrix:
        goos: [linux, windows]
        goarch: [amd64, arm64]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ðŸ“¦ Download dependencies
        run: go mod download

      - name: ðŸ”¨ Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          mkdir -p dist
          EXT=""
          if [ "${{ matrix.goos }}" = "windows" ]; then
            EXT=".exe"
          fi
          
          BINARY_NAME="${APP_NAME}-${{ matrix.goos }}-${{ matrix.goarch }}${EXT}"
          
          echo "ðŸ”¨ Building ${BINARY_NAME}"
          go build -ldflags="-s -w" -o "dist/${BINARY_NAME}" ./cmd/xcloud
          
          # Verify binary
          file "dist/${BINARY_NAME}" || true
          ls -la "dist/${BINARY_NAME}"

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: binaries-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/
          retention-days: 7

  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [lint-and-format]
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ðŸ”’ Run Gosec Security Scanner
        uses: securecodewarrior/github-action-gosec@master
        with:
          args: '-fmt sarif -out gosec.sarif ./...'

      - name: ðŸ“¤ Upload SARIF file
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: gosec.sarif

      - name: ðŸ›¡ï¸ Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ðŸ“¤ Upload Trivy scan results
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  release:
    name: ðŸš€ Release
    runs-on: ubuntu-latest
    needs: [build, security]
    if: github.event_name == 'release'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: ./artifacts

      - name: ðŸ“‹ List artifacts
        run: |
          echo "ðŸ“‹ Available artifacts:"
          find ./artifacts -type f -name "*" | sort

      - name: ðŸ“¦ Create release archives
        run: |
          mkdir -p release
          
          # Create archives for each platform
          for os_arch in linux-amd64 linux-arm64 windows-amd64 windows-arm64; do
            if [ -d "./artifacts/binaries-${os_arch}" ]; then
              cd "./artifacts/binaries-${os_arch}"
              
              if [[ "${os_arch}" == *"windows"* ]]; then
                zip -r "../../release/${APP_NAME}-${os_arch}.zip" *
              else
                tar -czf "../../release/${APP_NAME}-${os_arch}.tar.gz" *
              fi
              
              cd ../..
              echo "âœ… Created archive for ${os_arch}"
            else
              echo "âš ï¸  No artifacts found for ${os_arch}"
            fi
          done

      - name: ðŸ“¤ Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/*.zip
            release/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  benchmark:
    name: âš¡ Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ðŸ“¦ Download dependencies
        run: go mod download

      - name: âš¡ Run benchmarks
        run: |
          echo "âš¡ Running performance benchmarks..."
          go test -bench=. -benchmem -count=3 -timeout=10m ./... > benchmark_results.txt 2>&1 || true
          
          if [ -s benchmark_results.txt ]; then
            echo "ðŸ“Š Benchmark Results:"
            cat benchmark_results.txt
          else
            echo "â„¹ï¸  No benchmarks found"
          fi

      - name: ðŸ“¤ Upload benchmark results
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results
          path: benchmark_results.txt
          retention-days: 30

  notify:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [lint-and-format, test, build, security]
    if: always()
    
    steps:
      - name: ðŸ“¢ Workflow Summary
        run: |
          echo "## ðŸŽ¯ xCloud CLI - Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Job Results:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Lint & Format: ${{ needs.lint-and-format.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY  
          echo "- ðŸ”¨ Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Targets:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ Linux (amd64, arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸªŸ Windows (amd64, arm64)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Metrics:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”¤ Go Version: ${{ env.GO_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“… Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY