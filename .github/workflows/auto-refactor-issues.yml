name: 'ðŸ¤– Auto Refactor Issues'

on:
  issues:
    types: [opened, reopened]

permissions:
  issues: write
  contents: read

jobs:
  auto-assign:
    name: 'ðŸŽ¯ Auto-assign Issue'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: 'ðŸ“‹ Get Issue Details'
        id: issue_details
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            console.log('Issue details:', {
              number: issue.number,
              title: issue.title,
              author: issue.user.login,
              labels: issue.labels.map(l => l.name)
            });
            
            return {
              number: issue.number,
              title: issue.title,
              author: issue.user.login
            };

      - name: 'ðŸ‘¤ Auto-assign to Creator'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const creator = issue.user.login;
            
            console.log(`Assigning issue #${issue.number} to @${creator}...`);
            
            try {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                assignees: [creator]
              });
              
              console.log(`âœ… Successfully assigned to @${creator}`);
            } catch (error) {
              console.error(`âŒ Failed to assign: ${error.message}`);
              // Continue even if assignment fails
            }

      - name: 'ðŸ·ï¸ Add Auto-refactored Label'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const creator = issue.user.login;
            
            console.log('Adding labels...');
            
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['ðŸ¤– auto-refactored', `ðŸ‘¤ ${creator}`]
              });
              
              console.log('âœ… Labels added successfully');
            } catch (error) {
              console.error(`âš ï¸ Failed to add labels: ${error.message}`);
              // Continue even if labeling fails
            }

      - name: 'ðŸ’¬ Post Confirmation Comment'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const creator = issue.user.login;
            
            const comment = `## ðŸ¤– Issue Auto-Refactored
            
            OlÃ¡ @${creator}! ðŸ‘‹
            
            Esta issue foi automaticamente processada pelo **xCloud Automation System**.
            
            ### âœ… AÃ§Ãµes Executadas:
            - âœ“ Issue atribuÃ­da automaticamente para vocÃª
            - âœ“ Labels aplicadas: \`ðŸ¤– auto-refactored\`, \`ðŸ‘¤ ${creator}\`
            - âœ“ NotificaÃ§Ãµes enviadas
            
            ### ðŸ¤– AssistÃªncia DisponÃ­vel:
            
            @Copilot estÃ¡ disponÃ­vel para ajudar! VocÃª pode usar os seguintes comandos:
            
            - \`/gemini review\` - AnÃ¡lise completa do fluxo de automaÃ§Ã£o
            - \`/gemini analyze\` - AnÃ¡lise detalhada do cÃ³digo
            - \`/gemini suggest\` - SugestÃµes de melhorias
            - \`/gemini validate\` - ValidaÃ§Ã£o de configuraÃ§Ãµes
            
            ### ðŸ“Š Status do Workflow:
            - **Workflow**: auto-refactor-issues.yml
            - **ExecuÃ§Ã£o**: [Ver logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - **Sistema**: xCloud Automation v1.0
            
            ---
            
            *ðŸ¤– Este comentÃ¡rio foi gerado automaticamente pelo xCloud Bot*`;
            
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: comment
              });
              
              console.log('âœ… Confirmation comment posted');
            } catch (error) {
              console.error(`âš ï¸ Failed to post comment: ${error.message}`);
            }

      - name: 'ðŸ“Š Summary'
        run: |
          echo "## ðŸŽ‰ Auto-refactor completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Actions taken:" >> $GITHUB_STEP_SUMMARY
          echo "- Issue assigned to creator" >> $GITHUB_STEP_SUMMARY
          echo "- Labels applied" >> $GITHUB_STEP_SUMMARY
          echo "- Confirmation comment posted" >> $GITHUB_STEP_SUMMARY
          echo "- Copilot notified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links:" >> $GITHUB_STEP_SUMMARY
          echo "- [View Issue](https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }})" >> $GITHUB_STEP_SUMMARY
          echo "- [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
