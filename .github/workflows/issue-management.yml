name: 'ðŸ“‹ Issue Management'

on:
  issues:
    types: [opened, closed, reopened, labeled, unlabeled]
  issue_comment:
    types: [created]

concurrency:
  group: '${{ github.workflow }}-issue-${{ github.event.issue.number }}'
  cancel-in-progress: true

defaults:
  run:
    shell: 'bash'

jobs:
  manage-issue:
    name: 'ðŸ“‹ Gerenciar Issue'
    runs-on: 'ubuntu-latest'
    timeout-minutes: 5
    permissions:
      contents: 'read'
      issues: 'write'
      pull-requests: 'read'
    
    steps:
      - name: 'Generate GitHub App Token'
        id: 'generate_token'
        uses: 'actions/create-github-app-token@v1'
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_PRIVATE_KEY }}
          owner: 'PageCloudv1'
          repositories: 'xcloud-cli'

      - name: 'ðŸ·ï¸ Auto-Triage Issue'
        if: github.event.action == 'opened'
        uses: 'actions/github-script@v7'
        with:
          github-token: '${{ steps.generate_token.outputs.token }}'
          script: |
            const { title, body } = context.payload.issue;
            const issueText = `${title} ${body}`.toLowerCase();
            
            let labels = [];
            
            // Detectar tipo de issue
            if (issueText.includes('bug') || issueText.includes('erro') || issueText.includes('falha')) {
              labels.push('bug');
            } else if (issueText.includes('feature') || issueText.includes('enhancement') || issueText.includes('nova')) {
              labels.push('enhancement');
            } else if (issueText.includes('doc') || issueText.includes('documentaÃ§Ã£o')) {
              labels.push('documentation');
            } else if (issueText.includes('workflow') || issueText.includes('ci') || issueText.includes('cd')) {
              labels.push('workflow');
            }
            
            // Detectar prioridade
            if (issueText.includes('urgente') || issueText.includes('crÃ­tico') || issueText.includes('high')) {
              labels.push('priority/high');
            } else if (issueText.includes('mÃ©dio') || issueText.includes('medium')) {
              labels.push('priority/medium');
            } else {
              labels.push('priority/low');
            }
            
            // Detectar se Ã© para iniciantes
            if (issueText.includes('good first issue') || issueText.includes('iniciante')) {
              labels.push('good first issue');
            }
            
            // Aplicar labels se houver
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
              
              console.log(`Labels aplicadas: ${labels.join(', ')}`);
            }

      - name: 'ðŸŽ¯ xCloud CLI Specific Triage'
        if: github.event.action == 'opened'
        uses: 'actions/github-script@v7'
        with:
          github-token: '${{ steps.generate_token.outputs.token }}'
          script: |
            const { title, body } = context.payload.issue;
            const issueText = `${title} ${body}`.toLowerCase();
            
            let cliLabels = [];
            
            // Detectar Ã¡rea especÃ­fica do CLI
            if (issueText.includes('deploy') || issueText.includes('deployment')) {
              cliLabels.push('area/deploy');
            }
            if (issueText.includes('config') || issueText.includes('configuraÃ§Ã£o')) {
              cliLabels.push('area/config');
            }
            if (issueText.includes('auth') || issueText.includes('autenticaÃ§Ã£o')) {
              cliLabels.push('area/auth');
            }
            if (issueText.includes('logs') || issueText.includes('logging')) {
              cliLabels.push('area/logs');
            }
            
            // Adicionar label genÃ©rico do CLI
            cliLabels.push('xcloud-cli');
            
            // Aplicar labels especÃ­ficas do CLI
            if (cliLabels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: cliLabels
              });
            }

      - name: 'âœ… Issue Closed Notification'
        if: github.event.action == 'closed'
        uses: 'actions/github-script@v7'
        with:
          github-token: '${{ steps.generate_token.outputs.token }}'
          script: |
            const comment = `## âœ… Issue Finalizada
            
            ðŸŽ‰ Esta issue foi marcada como concluÃ­da!
            
            ### ðŸ“Š EstatÃ­sticas
            - **Aberta em**: ${new Date(context.payload.issue.created_at).toLocaleDateString('pt-BR')}
            - **Fechada em**: ${new Date().toLocaleDateString('pt-BR')}
            - **Assignee**: ${context.payload.issue.assignee?.login || 'NÃ£o atribuÃ­da'}
            
            ### ðŸš€ PrÃ³ximos Passos
            - Verificar se mudanÃ§as foram deployadas
            - Documentar soluÃ§Ãµes para referÃªncia futura
            - Considerar criar issues relacionadas se necessÃ¡rio
            
            ---
            ðŸ¤– *NotificaÃ§Ã£o automÃ¡tica â€¢ xCloud CLI Bot*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });